<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Analysis Dashboard - PRO Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { background: #0f172a; color: #e2e8f0; }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white; color: black; }
            
            /* Chart PDF print optimization */
            .chart-container, .chart-container-small {
                max-width: 100% !important;
                height: 250px !important;
                page-break-inside: avoid;
                overflow: hidden;
            }
            
            /* Layout adjustment */
            .max-w-\[1800px\] {
                max-width: 100% !important;
                padding: 0 10px !important;
            }
            
            /* Grid spacing adjustment */
            .grid {
                gap: 10px !important;
            }
        }
        
        .sensitivity-table {
            font-size: 11px;
            border-collapse: collapse;
        }
        
        .sensitivity-table th, .sensitivity-table td {
            padding: 6px 10px;
            border: 1px solid #334155;
            text-align: center;
        }
        
        .sensitivity-positive { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .sensitivity-negative { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .chart-container-small {
            position: relative;
            height: 250px;
            width: 100%;
        }
        
        .table-scroll {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .table-scroll::-webkit-scrollbar {
            width: 8px;
        }
        
        .table-scroll::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 4px;
        }
        
        .table-scroll::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        
        .table-scroll::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-[1800px] mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6 no-print">
            <h1 class="text-3xl font-bold text-blue-400">üíº Investment Analysis Dashboard - PRO</h1>
            <div class="flex gap-3">
                <button onclick="toggleDarkMode()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                    <i class="fas fa-moon"></i> Dark Mode
                </button>
                <button onclick="downloadTemplate()" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg transition">
                    <i class="fas fa-download"></i> Template
                </button>
                <button onclick="downloadExcel()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg transition">
                    <i class="fas fa-file-excel"></i> Excel
                </button>
                <button onclick="window.print()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg transition">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
                <button onclick="shareResults()" class="px-4 py-2 bg-pink-600 hover:bg-pink-500 rounded-lg transition">
                    <i class="fas fa-share-alt"></i> Share
                </button>
            </div>
        </div>

        <div class="grid grid-cols-12 gap-6">
            <!-- Left Input Panel -->
            <div class="col-span-5 space-y-4">
                
                <!-- Project Management -->
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <h2 class="text-lg font-semibold mb-3 text-blue-300">üìÅ Project Management</h2>
                    <div class="flex gap-2">
                        <input type="text" id="project-name" placeholder="Enter project name" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500">
                        <button onclick="saveProject()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg transition">Save</button>
                        <button onclick="loadProject()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg transition">Load</button>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
                    <div class="flex border-b border-gray-700">
                        <button onclick="switchTab('basic')" id="tab-basic" class="flex-1 px-4 py-3 bg-blue-600 text-white font-semibold transition text-sm">
                            üìä Basic Settings
                        </button>
                        <button onclick="switchTab('wacc')" id="tab-wacc" class="flex-1 px-4 py-3 bg-gray-700 hover:bg-gray-600 transition text-sm">
                            üßÆ WACC
                        </button>
                        <button onclick="switchTab('scenario')" id="tab-scenario" class="flex-1 px-4 py-3 bg-gray-700 hover:bg-gray-600 transition text-sm">
                            üé≠ Scenario
                        </button>
                    </div>
                    
                    <!-- Tab Content -->
                    <div class="p-4">
                        <!-- Basic Settings Tab -->
                        <div id="content-basic" class="space-y-3">
                            <!-- Excel Upload -->
                            <div>
                                <h3 class="text-sm font-semibold mb-2 text-green-300">üìä Upload Revenue Data</h3>
                                <input type="file" id="excel-upload" accept=".xlsx, .xls" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-sm" onchange="handleExcelUpload(event)">
                                <p class="text-xs text-gray-400 mt-1">* Automatically reads revenue data from Excel</p>
                            </div>

                            <!-- CAGR-based Revenue Generation -->
                            <div>
                                <h3 class="text-sm font-semibold mb-2 text-yellow-300">üìà CAGR-based Revenue Generation</h3>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div>
                                        <label class="text-xs text-gray-300">Base Year Revenue ($M)</label>
                                        <input type="number" id="initial-revenue" value="100" class="w-full px-2 py-1 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-300">CAGR (%)</label>
                                        <input type="number" id="cagr" value="15" step="0.1" class="w-full px-2 py-1 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                                    </div>
                                </div>
                                <button onclick="generateRevenue()" class="w-full px-3 py-2 bg-yellow-600 hover:bg-yellow-500 rounded-lg transition text-sm">Generate Revenue</button>
                            </div>

                            <!-- Basic Assumptions -->
                            <div>
                                <h3 class="text-sm font-semibold mb-2 text-purple-300">‚öôÔ∏è Basic Assumptions</h3>
                                <div class="space-y-2">
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="text-xs text-gray-300">Initial Investment ($M)</label>
                                            <input type="number" id="initial_investment" value="500" class="w-full px-2 py-1.5 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-300">Useful Life (Years)</label>
                                            <input type="number" id="useful_life" value="10" class="w-full px-2 py-1.5 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="text-xs text-gray-300">Analysis Period (Years)</label>
                                            <input type="number" id="analysis_period" value="10" min="1" max="20" class="w-full px-2 py-1.5 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-300">Tax Rate (%)</label>
                                            <input type="number" id="tax_rate" value="25" class="w-full px-2 py-1.5 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="text-xs text-gray-300">CAPEX (% of Revenue)</label>
                                            <input type="number" id="capex_rate" value="5" step="0.1" class="w-full px-2 py-1.5 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-300">NWC (% of Revenue)</label>
                                            <input type="number" id="nwc_rate" value="10" step="0.1" class="w-full px-2 py-1.5 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- WACC Tab -->
                        <div id="content-wacc" class="space-y-3 hidden">
                            <!-- Industry Preset -->
                            <div class="p-3 bg-gray-700 rounded-lg">
                                <label class="text-xs text-gray-300 block mb-2 font-semibold">Industry Quick Apply</label>
                                <select id="industry-preset" class="w-full px-2 py-1.5 bg-gray-600 border border-gray-500 rounded-lg text-sm" onchange="applyIndustryPreset()">
                                    <option value="">-- Select --</option>
                                    <option value="it">IT/Software (WACC ~8%)</option>
                                    <option value="manufacturing">Manufacturing (WACC ~10%)</option>
                                    <option value="retail">Retail (WACC ~9%)</option>
                                    <option value="healthcare">Healthcare (WACC ~7%)</option>
                                    <option value="construction">Construction (WACC ~11%)</option>
                                </select>
                            </div>

                            <div>
                                <label class="text-xs text-gray-300">WACC (%)</label>
                                <input type="number" id="discount_rate" value="10" step="0.1" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg mt-1">
                            </div>
                            
                            <!-- WACC Manual Calculation -->
                            <div class="bg-gray-700 p-3 rounded-lg space-y-2">
                                <h4 class="text-sm font-semibold text-blue-300">üìê WACC Direct Calculation</h4>
                                
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-xs text-gray-400">Debt Weight D/(D+E) (%)</label>
                                        <input type="number" id="debt-weight" value="30" class="w-full px-2 py-1 bg-gray-600 border border-gray-500 rounded text-sm mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">Cost of Debt (%)</label>
                                        <input type="number" id="cost-of-debt" value="5" step="0.1" class="w-full px-2 py-1 bg-gray-600 border border-gray-500 rounded text-sm mt-1">
                                    </div>
                                </div>
                                
                                <!-- Beta Adjustment -->
                                <div class="p-2 bg-gray-600 rounded-lg border border-blue-500">
                                    <p class="text-xs font-semibold text-blue-300 mb-2">üéØ Beta Adjustment (Unlever ‚Üí Relever)</p>
                                    <div class="grid grid-cols-2 gap-2 mb-2">
                                        <div>
                                            <label class="text-xs text-gray-400">Unlevered Œ≤</label>
                                            <input type="number" id="unlevered-beta" value="0.8" step="0.01" class="w-full px-2 py-1 bg-gray-700 border border-gray-500 rounded text-xs mt-1">
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-400">Target D/E (%)</label>
                                            <input type="number" id="target-de" value="40" class="w-full px-2 py-1 bg-gray-700 border border-gray-500 rounded text-xs mt-1">
                                        </div>
                                    </div>
                                    <button onclick="calculateReleverBeta()" class="w-full px-2 py-1 bg-blue-600 hover:bg-blue-500 rounded text-xs transition">
                                        Calculate Levered Œ≤
                                    </button>
                                </div>
                                
                                <!-- CAPM -->
                                <details class="bg-gray-600 p-2 rounded-lg">
                                    <summary class="cursor-pointer text-xs font-semibold text-green-300 mb-2">CAPM Calculation</summary>
                                    <div class="space-y-2 mt-2">
                                        <div class="grid grid-cols-3 gap-2">
                                            <div>
                                                <label class="text-xs text-gray-400">Risk-free Rate (%)</label>
                                                <input type="number" id="risk-free-rate" value="3.5" step="0.1" class="w-full px-2 py-1 bg-gray-700 border border-gray-500 rounded text-xs mt-1">
                                            </div>
                                            <div>
                                                <label class="text-xs text-gray-400">Market Return (%)</label>
                                                <input type="number" id="market-return" value="9" step="0.1" class="w-full px-2 py-1 bg-gray-700 border border-gray-500 rounded text-xs mt-1">
                                            </div>
                                            <div>
                                                <label class="text-xs text-gray-400">Beta (Œ≤)</label>
                                                <input type="number" id="beta" value="1.2" step="0.01" class="w-full px-2 py-1 bg-gray-700 border border-gray-500 rounded text-xs mt-1">
                                            </div>
                                        </div>
                                        <button onclick="calculateCAPM()" class="w-full px-2 py-1 bg-green-600 hover:bg-green-500 rounded text-xs transition">
                                            Calculate Cost of Equity
                                        </button>
                                        <div id="capm-result" class="text-xs text-green-300"></div>
                                    </div>
                                </details>
                                
                                <div>
                                    <label class="text-xs text-gray-400">Cost of Equity (%)</label>
                                    <input type="number" id="cost-of-equity" value="12" step="0.1" class="w-full px-2 py-1 bg-gray-600 border border-gray-500 rounded text-sm mt-1">
                                </div>
                                
                                <button onclick="calculateWACC()" class="w-full px-3 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg transition text-sm">
                                    Calculate WACC
                                </button>
                                <div id="wacc-result" class="text-xs text-cyan-300"></div>
                                <div id="wacc-formula" class="text-xs text-gray-400 p-2 bg-gray-800 rounded"></div>
                            </div>
                        </div>

                        <!-- Scenario Tab -->
                        <div id="content-scenario" class="space-y-3 hidden">
                            <!-- Terminal Value -->
                            <div>
                                <h3 class="text-sm font-semibold mb-2 text-orange-300">üí∞ Terminal Value</h3>
                                <div class="mb-2">
                                    <label class="text-xs text-gray-300">Calculation Method</label>
                                    <select id="tv-method" class="w-full px-2 py-1.5 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm" onchange="toggleTVInputs()">
                                        <option value="liquidation">Liquidation Value</option>
                                        <option value="perpetual">Perpetual Growth</option>
                                        <option value="exit-multiple">Exit Multiple</option>
                                    </select>
                                </div>
                                <div id="tv-inputs"></div>
                            </div>

                            <!-- Scenario Selection -->
                            <div>
                                <h3 class="text-sm font-semibold mb-2 text-pink-300">üé≠ Scenario Selection</h3>
                                <div class="grid grid-cols-3 gap-2">
                                    <button onclick="applyScenario('conservative')" class="px-3 py-2 bg-red-600 hover:bg-red-500 rounded-lg transition text-sm">Conservative</button>
                                    <button onclick="applyScenario('base')" class="px-3 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg transition text-sm">Base</button>
                                    <button onclick="applyScenario('optimistic')" class="px-3 py-2 bg-green-600 hover:bg-green-500 rounded-lg transition text-sm">Optimistic</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calculate Button -->
                <button onclick="calculate()" class="w-full px-6 py-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 rounded-xl text-lg font-bold transition shadow-lg">
                    üöÄ Start Analysis
                </button>
            </div>

            <!-- Right Results Panel -->
            <div class="col-span-7 space-y-4">
                
                <!-- KPI Cards -->
                <div class="grid grid-cols-5 gap-3">
                    <div class="bg-gradient-to-br from-blue-600 to-blue-700 p-4 rounded-xl text-center">
                        <p class="text-sm text-blue-200">NPV</p>
                        <p id="npv-value" class="text-2xl font-bold mt-1">-</p>
                        <p class="text-xs text-blue-200 mt-1">$M</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-600 to-green-700 p-4 rounded-xl text-center">
                        <p class="text-sm text-green-200">IRR</p>
                        <p id="irr-value" class="text-2xl font-bold mt-1">-</p>
                        <p class="text-xs text-green-200 mt-1">%</p>
                    </div>
                    <div class="bg-gradient-to-br from-yellow-600 to-yellow-700 p-4 rounded-xl text-center">
                        <p class="text-sm text-yellow-200">Payback Period</p>
                        <p id="payback-value" class="text-2xl font-bold mt-1">-</p>
                        <p class="text-xs text-yellow-200 mt-1">Years</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-600 to-purple-700 p-4 rounded-xl text-center">
                        <p class="text-sm text-purple-200">BEP</p>
                        <p id="bep-value" class="text-2xl font-bold mt-1">-</p>
                        <p class="text-xs text-purple-200 mt-1">Years</p>
                    </div>
                    <div id="verdict-card" class="bg-gradient-to-br from-gray-600 to-gray-700 p-4 rounded-xl text-center">
                        <p class="text-sm text-gray-200">Investment Decision</p>
                        <p id="verdict-value" class="text-2xl font-bold mt-1">-</p>
                    </div>
                </div>

                <!-- Support Banner (shown after successful analysis) -->
                <div id="support-banner" class="hidden bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 rounded-xl p-4 relative">
                    <button onclick="document.getElementById('support-banner').classList.add('hidden'); localStorage.setItem('supportBannerDismissed', 'true');" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 text-xl leading-none">√ó</button>
                    <div class="flex items-center gap-4">
                        <div class="text-4xl">‚òï</div>
                        <div class="flex-1">
                            <p class="font-bold text-gray-800 mb-1">Analysis saved you hours of work!</p>
                            <p class="text-sm text-gray-600">If this tool helped you, consider buying me a coffee ‚òï</p>
                        </div>
                        <a href="https://paypal.me/LOCUJO" target="_blank" class="px-6 py-2 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition whitespace-nowrap">
                            Support
                        </a>
                    </div>
                </div>

                <!-- Monte Carlo Simulation -->
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-semibold text-red-300">üé≤ Monte Carlo Simulation</h2>
                        <button onclick="runMonteCarloSimulation()" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg transition text-sm">
                            Run Simulation
                        </button>
                    </div>
                    <div class="chart-container-small">
                        <canvas id="monte-carlo-chart"></canvas>
                    </div>
                    <div id="mc-stats" class="grid grid-cols-4 gap-3 mt-3 text-center text-sm"></div>
                </div>

                <!-- Scenario Comparison -->
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <h2 class="text-lg font-semibold mb-3 text-blue-300">üìä Scenario Comparison</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-4 py-2 text-left">Metric</th>
                                    <th class="px-4 py-2 text-center">Conservative</th>
                                    <th class="px-4 py-2 text-center">Base</th>
                                    <th class="px-4 py-2 text-center">Optimistic</th>
                                </tr>
                            </thead>
                            <tbody id="scenario-table-body" class="divide-y divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 1-Way Sensitivity Analysis -->
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <h2 class="text-lg font-semibold mb-3 text-yellow-300">üéØ Sensitivity Analysis (1-Way)</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-4 py-2 text-left">Variable</th>
                                    <th class="px-4 py-2 text-center">-20%</th>
                                    <th class="px-4 py-2 text-center">-10%</th>
                                    <th class="px-4 py-2 text-center">Base</th>
                                    <th class="px-4 py-2 text-center">+10%</th>
                                    <th class="px-4 py-2 text-center">+20%</th>
                                </tr>
                            </thead>
                            <tbody id="sensitivity-table-body" class="divide-y divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 2-Way Sensitivity Analysis -->
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <h2 class="text-lg font-semibold mb-3 text-orange-300">üéØüéØ 2-Way Sensitivity Analysis (Revenue √ó WACC)</h2>
                    <div class="overflow-x-auto">
                        <table id="sensitivity-2way-table" class="sensitivity-table w-full">
                        </table>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">* Green: NPV > 0 (Investable), Red: NPV < 0 (Not Investable)</p>
                </div>

                <!-- Cashflow Chart -->
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <h2 class="text-lg font-semibold mb-3 text-green-300">üìà Cash Flow Chart</h2>
                    <div class="chart-container">
                        <canvas id="cashflow-chart"></canvas>
                    </div>
                </div>

                <!-- Annual FCF Table -->
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <h2 class="text-lg font-semibold mb-3 text-purple-300">üìã Annual Free Cash Flow</h2>
                    <div class="overflow-x-auto table-scroll">
                        <table class="w-full text-xs">
                            <thead class="bg-gray-700 sticky top-0">
                                <tr>
                                    <th class="px-2 py-2">Year</th>
                                    <th class="px-2 py-2">Revenue</th>
                                    <th class="px-2 py-2">Op. Profit</th>
                                    <th class="px-2 py-2">NOPAT</th>
                                    <th class="px-2 py-2">D&A</th>
                                    <th class="px-2 py-2">CAPEX</th>
                                    <th class="px-2 py-2">ŒîNWC</th>
                                    <th class="px-2 py-2">FCF</th>
                                    <th class="px-2 py-2">Disc. FCF</th>
                                </tr>
                            </thead>
                            <tbody id="fcf-table-body" class="divide-y divide-gray-700 text-center">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 px-6 py-3 bg-green-600 text-white rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300"></div>

    <script>
        let projectData = {
            revenues: [],
            margins: [],
            currentScenario: 'base',
            lastFCFData: []
        };

        let charts = {
            cashflow: null,
            monteCarlo: null
        };

        // Number Formatter with Commas
        function formatNumber(num, decimals = 1) {
            return num.toLocaleString('en-US', { 
                minimumFractionDigits: decimals, 
                maximumFractionDigits: decimals 
            });
        }

        // Toast Notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 ${
                type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'
            } text-white transform translate-y-0 opacity-100`;
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // Tab Switching
        function switchTab(tabName) {
            ['basic', 'wacc', 'scenario'].forEach(name => {
                const btn = document.getElementById(`tab-${name}`);
                const content = document.getElementById(`content-${name}`);
                
                if (name === tabName) {
                    btn.className = 'flex-1 px-4 py-3 bg-blue-600 text-white font-semibold transition text-sm';
                    content.classList.remove('hidden');
                } else {
                    btn.className = 'flex-1 px-4 py-3 bg-gray-700 hover:bg-gray-600 transition text-sm';
                    content.classList.add('hidden');
                }
            });
        }

        // Dark Mode Toggle
        function toggleDarkMode() {
            document.body.classList.toggle('bg-gray-100');
            document.body.classList.toggle('text-gray-900');
            showToast('Dark mode toggled');
        }

        // TV Input Fields Dynamic Change
        function toggleTVInputs() {
            const method = document.getElementById('tv-method').value;
            const container = document.getElementById('tv-inputs');
            
            if (method === 'liquidation') {
                container.innerHTML = `
                    <div>
                        <label class="text-xs text-gray-300">Liquidation Value ($M)</label>
                        <input type="number" id="liquidation-value" value="100" class="w-full px-2 py-1.5 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                    </div>
                `;
            } else if (method === 'perpetual') {
                container.innerHTML = `
                    <div>
                        <label class="text-xs text-gray-300">Perpetual Growth Rate (g) (%)</label>
                        <input type="number" id="growth-rate" value="2" step="0.1" class="w-full px-2 py-1.5 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                        <p class="text-xs text-yellow-300 mt-1">‚ö†Ô∏è Note: WACC must be greater than growth rate</p>
                    </div>
                `;
            } else if (method === 'exit-multiple') {
                container.innerHTML = `
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-gray-300">Exit Multiple (EV/EBITDA)</label>
                            <input type="number" id="exit-multiple" value="10" step="0.1" class="w-full px-2 py-1.5 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-gray-300">Base Metric</label>
                            <select id="exit-metric" class="w-full px-2 py-1.5 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                                <option value="ebitda">EBITDA</option>
                                <option value="revenue">Revenue</option>
                            </select>
                        </div>
                    </div>
                `;
            }
        }

        // Initialize TV Input Fields
        toggleTVInputs();

        // Industry Preset Application
        function applyIndustryPreset() {
            const industry = document.getElementById('industry-preset').value;
            const presets = {
                'it': { wacc: 8, debtWeight: 10, costOfDebt: 4, costOfEquity: 8.5 },
                'manufacturing': { wacc: 10, debtWeight: 40, costOfDebt: 5, costOfEquity: 13 },
                'retail': { wacc: 9, debtWeight: 30, costOfDebt: 4.5, costOfEquity: 11 },
                'healthcare': { wacc: 7, debtWeight: 20, costOfDebt: 3.5, costOfEquity: 8 },
                'construction': { wacc: 11, debtWeight: 50, costOfDebt: 6, costOfEquity: 14 }
            };
            
            if (presets[industry]) {
                document.getElementById('discount_rate').value = presets[industry].wacc;
                document.getElementById('debt-weight').value = presets[industry].debtWeight;
                document.getElementById('cost-of-debt').value = presets[industry].costOfDebt;
                document.getElementById('cost-of-equity').value = presets[industry].costOfEquity;
                showToast(`${industry.toUpperCase()} industry preset applied`);
            }
        }

        // Beta Adjustment Calculation (Hamada Formula)
        function calculateReleverBeta() {
            const unleveredBeta = parseFloat(document.getElementById('unlevered-beta').value);
            const targetDE = parseFloat(document.getElementById('target-de').value) / 100;
            const taxRate = parseFloat(document.getElementById('tax_rate').value) / 100;
            
            const leveredBeta = unleveredBeta * (1 + (1 - taxRate) * targetDE);
            
            document.getElementById('beta').value = leveredBeta.toFixed(2);
            showToast(`Levered Œ≤ = ${leveredBeta.toFixed(2)}`);
        }

        // CAPM Calculation
        function calculateCAPM() {
            const rf = parseFloat(document.getElementById('risk-free-rate').value) / 100;
            const rm = parseFloat(document.getElementById('market-return').value) / 100;
            const beta = parseFloat(document.getElementById('beta').value);
            
            const costOfEquity = rf + beta * (rm - rf);
            document.getElementById('cost-of-equity').value = (costOfEquity * 100).toFixed(2);
            
            document.getElementById('capm-result').innerHTML = `
                Re = ${(rf * 100).toFixed(1)}% + ${beta.toFixed(2)} √ó (${(rm * 100).toFixed(1)}% - ${(rf * 100).toFixed(1)}%)
                = <strong>${(costOfEquity * 100).toFixed(2)}%</strong>
            `;
            
            showToast('Cost of equity calculated');
        }

        // WACC Calculation
        function calculateWACC() {
            const debtWeight = parseFloat(document.getElementById('debt-weight').value) / 100;
            const equityWeight = 1 - debtWeight;
            const costOfDebt = parseFloat(document.getElementById('cost-of-debt').value) / 100;
            const costOfEquity = parseFloat(document.getElementById('cost-of-equity').value) / 100;
            const taxRate = parseFloat(document.getElementById('tax_rate').value) / 100;
            
            const wacc = (debtWeight * costOfDebt * (1 - taxRate)) + (equityWeight * costOfEquity);
            
            document.getElementById('discount_rate').value = (wacc * 100).toFixed(2);
            
            document.getElementById('wacc-formula').innerHTML = `
                <strong>WACC Calculation:</strong><br>
                WACC = (D/(D+E) √ó Rd √ó (1-T)) + (E/(D+E) √ó Re)<br>
                = (${(debtWeight * 100).toFixed(1)}% √ó ${(costOfDebt * 100).toFixed(1)}% √ó ${((1-taxRate) * 100).toFixed(0)}%) 
                + (${(equityWeight * 100).toFixed(1)}% √ó ${(costOfEquity * 100).toFixed(1)}%)<br>
                = <strong style="color: #22d3ee;">${(wacc * 100).toFixed(2)}%</strong>
            `;
            
            document.getElementById('wacc-result').innerHTML = `Result: <strong>${(wacc * 100).toFixed(2)}%</strong>`;
            
            showToast('WACC calculated!');
        }

        // Excel Upload
        function handleExcelUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                projectData.revenues = jsonData.slice(1).map(row => parseFloat(row[0]) || 0);
                
                showToast('Excel data uploaded!');
                calculate();
            };
            reader.readAsArrayBuffer(file);
        }

        // CAGR-based Revenue Generation
        function generateRevenue() {
            const initialRevenue = parseFloat(document.getElementById('initial-revenue').value);
            const cagr = parseFloat(document.getElementById('cagr').value) / 100;
            const period = parseInt(document.getElementById('analysis_period').value);
            
            projectData.revenues = [];
            for (let i = 0; i < period; i++) {
                projectData.revenues.push(initialRevenue * Math.pow(1 + cagr, i));
            }
            
            showToast('Revenue data generated!');
        }

        // Scenario Application
        function applyScenario(scenario) {
            const scenarios = {
                'conservative': { marginMultiplier: 0.8, wacc: 12 },
                'base': { marginMultiplier: 1.0, wacc: 10 },
                'optimistic': { marginMultiplier: 1.2, wacc: 8 }
            };
            
            const selected = scenarios[scenario];
            document.getElementById('discount_rate').value = selected.wacc;
            projectData.currentScenario = scenario;
            
            showToast(`${scenario.charAt(0).toUpperCase() + scenario.slice(1)} scenario applied`);
            calculate();
        }

        // IRR Calculation (Improved Convergence Logic)
        function calculateIRR(cashflows) {
            let low = -0.99, high = 5.0;
            const tolerance = 0.0001;
            const maxIterations = 200;
            
            for (let k = 0; k < maxIterations; k++) {
                let mid = (low + high) / 2;
                let npv = 0;
                
                cashflows.forEach((cf, i) => {
                    npv += cf / Math.pow(1 + mid, i);
                });
                
                if (Math.abs(npv) < tolerance) {
                    return mid * 100;
                }
                
                if (npv > 0) {
                    low = mid;
                } else {
                    high = mid;
                }
            }
            
            return ((low + high) / 2) * 100;
        }

        // Quick NPV Calculation
        function quickCalculateNPV() {
            const initialInvestment = parseFloat(document.getElementById('initial_investment').value);
            const period = parseInt(document.getElementById('analysis_period').value);
            const taxRate = parseFloat(document.getElementById('tax_rate').value) / 100;
            const discountRate = parseFloat(document.getElementById('discount_rate').value) / 100;
            const nwcRate = parseFloat(document.getElementById('nwc_rate').value) / 100;
            const capexRate = parseFloat(document.getElementById('capex_rate').value) / 100;
            
            const revenues = projectData.revenues.length > 0 ? projectData.revenues : 
                             Array.from({length: period}, (_, i) => {
                                 const initial = parseFloat(document.getElementById('initial-revenue').value);
                                 const cagr = parseFloat(document.getElementById('cagr').value) / 100;
                                 return initial * Math.pow(1 + cagr, i);
                             });
            
            let npv = -initialInvestment;
            let prevNWC = 0;
            const depreciation = initialInvestment / parseInt(document.getElementById('useful_life').value);
            
            for (let year = 1; year <= period; year++) {
                const revenue = revenues[year - 1] || 0;
                const operatingProfit = revenue * 0.2;
                const nopat = operatingProfit * (1 - taxRate);
                
                const capex = revenue * capexRate;
                const currentNWC = revenue * nwcRate;
                const nwcIncrease = currentNWC - prevNWC;
                prevNWC = currentNWC;
                
                let fcf = nopat + depreciation - capex - nwcIncrease;
                
                if (year === period) {
                    fcf += currentNWC;
                }
                
                npv += fcf / Math.pow(1 + discountRate, year);
            }
            
            return npv;
        }

        // Main Calculation Function
        function calculate() {
            try {
                const initialInvestment = parseFloat(document.getElementById('initial_investment').value);
                const usefulLife = parseInt(document.getElementById('useful_life').value);
                const period = parseInt(document.getElementById('analysis_period').value);
                const taxRate = parseFloat(document.getElementById('tax_rate').value) / 100;
                const discountRate = parseFloat(document.getElementById('discount_rate').value) / 100;
                const nwcRate = parseFloat(document.getElementById('nwc_rate').value) / 100;
                const capexRate = parseFloat(document.getElementById('capex_rate').value) / 100;
                
                if (projectData.revenues.length === 0) {
                    generateRevenue();
                }
                
                const depreciation = initialInvestment / usefulLife;
                
                const cashflows = [-initialInvestment];
                const fcfData = [];
                let prevNWC = 0;
                
                for (let year = 1; year <= period; year++) {
                    const revenue = projectData.revenues[year - 1] || 0;
                    const operatingMargin = 0.2;
                    const operatingProfit = revenue * operatingMargin;
                    const nopat = operatingProfit * (1 - taxRate);
                    
                    const capex = revenue * capexRate;
                    const currentNWC = revenue * nwcRate;
                    const nwcIncrease = currentNWC - prevNWC;
                    prevNWC = currentNWC;
                    
                    let fcf = nopat + depreciation - capex - nwcIncrease;
                    
                    if (year === period) {
                        const tvMethod = document.getElementById('tv-method').value;
                        let residual = 0;
                        
                        if (tvMethod === 'liquidation') {
                            residual = parseFloat(document.getElementById('liquidation-value').value);
                        } else if (tvMethod === 'perpetual') {
                            const g = parseFloat(document.getElementById('growth-rate').value) / 100;
                            
                            // Validation: WACC must be greater than growth rate
                            if (discountRate <= g) {
                                showToast('Error: WACC must be greater than growth rate (g)', 'error');
                                return;
                            }
                            
                            const normalizedFCF = nopat + depreciation - capex;
                            const terminalValue = normalizedFCF * (1 + g) / (discountRate - g);
                            residual = terminalValue + currentNWC;
                        } else if (tvMethod === 'exit-multiple') {
                            const multiple = parseFloat(document.getElementById('exit-multiple').value);
                            const metric = document.getElementById('exit-metric').value;
                            residual = (metric === 'ebitda' ? operatingProfit : revenue) * multiple;
                        }
                        
                        fcf += residual;
                    }
                    
                    cashflows.push(fcf);
                    
                    const discountedFCF = fcf / Math.pow(1 + discountRate, year);
                    
                    fcfData.push({
                        year,
                        revenue,
                        operatingProfit,
                        nopat,
                        depreciation,
                        capex,
                        nwcIncrease,
                        fcf,
                        discountedFCF
                    });
                }
                
                projectData.lastFCFData = fcfData;
                
                const npv = cashflows.reduce((sum, cf, i) => sum + cf / Math.pow(1 + discountRate, i), 0);
                const irr = calculateIRR(cashflows);
                
                let cumulativeCF = -initialInvestment;
                let paybackPeriod = period;
                for (let i = 0; i < fcfData.length; i++) {
                    cumulativeCF += fcfData[i].fcf;
                    if (cumulativeCF >= 0) {
                        paybackPeriod = i + 1;
                        break;
                    }
                }
                
                // BEP Calculation
                let cumulativeProfit = 0;
                let bep = period;
                for (let i = 0; i < fcfData.length; i++) {
                    cumulativeProfit += fcfData[i].nopat + fcfData[i].depreciation;
                    
                    if (cumulativeProfit >= initialInvestment) {
                        bep = i + 1;
                        break;
                    }
                }
                
                document.getElementById('npv-value').textContent = formatNumber(npv);
                document.getElementById('irr-value').textContent = formatNumber(irr, 2);
                document.getElementById('payback-value').textContent = paybackPeriod;
                document.getElementById('bep-value').textContent = bep;
                
                const verdict = npv > 0 && irr > discountRate * 100 ? '‚úÖ Invest' : '‚ùå Pass';
                const verdictCard = document.getElementById('verdict-card');
                document.getElementById('verdict-value').textContent = verdict;
                verdictCard.className = npv > 0 ? 
                    'bg-gradient-to-br from-green-600 to-green-700 p-4 rounded-xl text-center' :
                    'bg-gradient-to-br from-red-600 to-red-700 p-4 rounded-xl text-center';
                
                updateCashflowChart(fcfData);
                updateFCFTable(fcfData);
                updateScenarioComparison(npv, irr);
                calculate1WaySensitivity();
                calculate2WaySensitivity();
                
                // Show support banner only on positive NPV (successful investment)
                if (npv > 0 && !localStorage.getItem('supportBannerDismissed')) {
                    setTimeout(() => {
                        document.getElementById('support-banner').classList.remove('hidden');
                    }, 1000);
                }
                
                showToast('Analysis complete!', 'success');
                
            } catch (error) {
                console.error('Calculation error:', error);
                showToast('An error occurred during calculation', 'error');
            }
        }

        // Scenario Comparison Table Update
        function updateScenarioComparison(baseNPV, baseIRR) {
            const scenarios = {
                'conservative': { margin: 0.85, wacc: 12 },
                'base': { margin: 1.0, wacc: 10 },
                'optimistic': { margin: 1.15, wacc: 8 }
            };
            
            const tbody = document.getElementById('scenario-table-body');
            tbody.innerHTML = '';
            
            const metrics = [
                { name: 'NPV ($M)', key: 'npv' },
                { name: 'IRR (%)', key: 'irr' },
                { name: 'Payback Period (Years)', key: 'payback' }
            ];
            
            metrics.forEach(metric => {
                const row = document.createElement('tr');
                let cells = `<td class="px-4 py-2 font-semibold">${metric.name}</td>`;
                
                Object.keys(scenarios).forEach(scenario => {
                    const multiplier = scenarios[scenario].margin;
                    let value;
                    
                    if (metric.key === 'npv') {
                        value = formatNumber(baseNPV * multiplier);
                    } else if (metric.key === 'irr') {
                        value = formatNumber(baseIRR * multiplier, 2);
                    } else {
                        value = Math.max(1, Math.floor(5 / multiplier));
                    }
                    
                    const color = parseFloat(value.replace(/,/g, '')) > 0 ? 'text-green-400' : 'text-red-400';
                    cells += `<td class="px-4 py-2 text-center ${color}">${value}</td>`;
                });
                
                row.innerHTML = cells;
                tbody.appendChild(row);
            });
        }

        // 1-Way Sensitivity Analysis
        function calculate1WaySensitivity() {
            const tbody = document.getElementById('sensitivity-table-body');
            tbody.innerHTML = '';
            
            const baseValues = {
                revenue: parseFloat(document.getElementById('initial-revenue').value),
                wacc: parseFloat(document.getElementById('discount_rate').value),
                nwcRate: parseFloat(document.getElementById('nwc_rate').value) / 100
            };
            
            const variables = [
                { name: 'Base Year Revenue', field: 'revenue', id: 'initial-revenue' },
                { name: 'WACC', field: 'wacc', id: 'discount_rate' },
                { name: 'NWC Ratio', field: 'nwcRate', id: 'nwc_rate', isPercent: true }
            ];
            
            variables.forEach(variable => {
                const row = document.createElement('tr');
                const variations = [-0.2, -0.1, 0, 0.1, 0.2];
                
                let cells = `<td class="px-4 py-2">${variable.name}</td>`;
                
                variations.forEach(variation => {
                    const originalValue = document.getElementById(variable.id).value;
                    const adjustedValue = baseValues[variable.field] * (1 + variation);
                    
                    if (variable.isPercent) {
                        document.getElementById(variable.id).value = adjustedValue * 100;
                    } else {
                        document.getElementById(variable.id).value = adjustedValue;
                    }
                    
                    const npv = quickCalculateNPV();
                    
                    document.getElementById(variable.id).value = originalValue;
                    
                    const color = npv > 0 ? 'text-green-400' : 'text-red-400';
                    cells += `<td class="px-4 py-2 text-center ${color}">${formatNumber(npv)}</td>`;
                });
                
                row.innerHTML = cells;
                tbody.appendChild(row);
            });
        }

        // 2-Way Sensitivity Analysis
        function calculate2WaySensitivity() {
            const baseRevenue = parseFloat(document.getElementById('initial-revenue').value);
            const baseWACC = parseFloat(document.getElementById('discount_rate').value);
            
            const revenueVariations = [-0.2, -0.1, 0, 0.1, 0.2];
            const waccVariations = [-2, -1, 0, 1, 2];
            
            const table = document.getElementById('sensitivity-2way-table');
            table.innerHTML = '';
            
            let headerRow = '<tr><th>Revenue \\ WACC</th>';
            waccVariations.forEach(wv => {
                const waccValue = (baseWACC + wv).toFixed(1);
                headerRow += `<th>${waccValue}%</th>`;
            });
            headerRow += '</tr>';
            table.innerHTML += headerRow;
            
            const originalRevenue = document.getElementById('initial-revenue').value;
            const originalWACC = document.getElementById('discount_rate').value;
            
            revenueVariations.forEach(rv => {
                const revenueValue = formatNumber(baseRevenue * (1 + rv), 0);
                let row = `<tr><td>$${revenueValue}M</td>`;
                
                waccVariations.forEach(wv => {
                    document.getElementById('initial-revenue').value = baseRevenue * (1 + rv);
                    document.getElementById('discount_rate').value = baseWACC + wv;
                    
                    const npv = quickCalculateNPV();
                    
                    const cellClass = npv > 0 ? 'sensitivity-positive' : 'sensitivity-negative';
                    row += `<td class="${cellClass}">${formatNumber(npv, 0)}</td>`;
                });
                
                row += '</tr>';
                table.innerHTML += row;
            });
            
            document.getElementById('initial-revenue').value = originalRevenue;
            document.getElementById('discount_rate').value = originalWACC;
        }

        // Cash Flow Chart
        function updateCashflowChart(fcfData) {
            const ctx = document.getElementById('cashflow-chart').getContext('2d');
            
            if (charts.cashflow) {
                charts.cashflow.destroy();
            }
            
            charts.cashflow = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: fcfData.map(d => `Y${d.year}`),
                    datasets: [{
                        label: 'FCF ($M)',
                        data: fcfData.map(d => d.fcf),
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                color: '#94a3b8',
                                callback: function(value) {
                                    return '$' + formatNumber(value, 0) + 'M';
                                }
                            },
                            grid: { color: '#334155' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });
        }

        // FCF Table Update
        function updateFCFTable(fcfData) {
            const tbody = document.getElementById('fcf-table-body');
            tbody.innerHTML = '';
            
            fcfData.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-2 py-2">${data.year}</td>
                    <td class="px-2 py-2">${formatNumber(data.revenue)}</td>
                    <td class="px-2 py-2">${formatNumber(data.operatingProfit)}</td>
                    <td class="px-2 py-2">${formatNumber(data.nopat)}</td>
                    <td class="px-2 py-2">${formatNumber(data.depreciation)}</td>
                    <td class="px-2 py-2">${formatNumber(data.capex)}</td>
                    <td class="px-2 py-2">${formatNumber(data.nwcIncrease)}</td>
                    <td class="px-2 py-2 font-bold">${formatNumber(data.fcf)}</td>
                    <td class="px-2 py-2 text-blue-400">${formatNumber(data.discountedFCF)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Monte Carlo Simulation
        function runMonteCarloSimulation() {
            const simulations = 1000;
            const results = [];
            
            const originalRevenue = document.getElementById('initial-revenue').value;
            const originalWACC = document.getElementById('discount_rate').value;
            
            for (let i = 0; i < simulations; i++) {
                const randomRevenue = parseFloat(originalRevenue) * (0.8 + Math.random() * 0.4);
                const randomWACC = parseFloat(originalWACC) * (0.9 + Math.random() * 0.2);
                
                document.getElementById('initial-revenue').value = randomRevenue;
                document.getElementById('discount_rate').value = randomWACC;
                
                const npv = quickCalculateNPV();
                results.push(npv);
            }
            
            document.getElementById('initial-revenue').value = originalRevenue;
            document.getElementById('discount_rate').value = originalWACC;
            
            results.sort((a, b) => a - b);
            const mean = results.reduce((a, b) => a + b, 0) / results.length;
            const p10 = results[Math.floor(simulations * 0.1)];
            const p50 = results[Math.floor(simulations * 0.5)];
            const p90 = results[Math.floor(simulations * 0.9)];
            
            document.getElementById('mc-stats').innerHTML = `
                <div class="bg-gray-700 p-2 rounded-lg">
                    <p class="text-xs text-gray-400">Mean NPV</p>
                    <p class="text-base font-bold">$${formatNumber(mean)}M</p>
                </div>
                <div class="bg-gray-700 p-2 rounded-lg">
                    <p class="text-xs text-gray-400">P10</p>
                    <p class="text-base font-bold">$${formatNumber(p10)}M</p>
                </div>
                <div class="bg-gray-700 p-2 rounded-lg">
                    <p class="text-xs text-gray-400">P50</p>
                    <p class="text-base font-bold">$${formatNumber(p50)}M</p>
                </div>
                <div class="bg-gray-700 p-2 rounded-lg">
                    <p class="text-xs text-gray-400">P90</p>
                    <p class="text-base font-bold">$${formatNumber(p90)}M</p>
                </div>
            `;
            
            const ctx = document.getElementById('monte-carlo-chart').getContext('2d');
            if (charts.monteCarlo) {
                charts.monteCarlo.destroy();
            }
            
            const bins = 20;
            const binSize = (Math.max(...results) - Math.min(...results)) / bins;
            const histogram = new Array(bins).fill(0);
            
            results.forEach(r => {
                const binIndex = Math.min(Math.floor((r - Math.min(...results)) / binSize), bins - 1);
                histogram[binIndex]++;
            });
            
            charts.monteCarlo = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: histogram.map((_, i) => formatNumber((Math.min(...results) + binSize * i), 0)),
                    datasets: [{
                        label: 'Frequency',
                        data: histogram,
                        backgroundColor: 'rgba(239, 68, 68, 0.6)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                        x: { 
                            ticks: { 
                                color: '#94a3b8', 
                                maxRotation: 45, 
                                minRotation: 45,
                                callback: function(value, index) {
                                    return '$' + this.getLabelForValue(value) + 'M';
                                }
                            }, 
                            grid: { color: '#334155' } 
                        }
                    }
                }
            });
            
            showToast('Monte Carlo simulation complete!');
        }

        // Project Save
        function saveProject() {
            const projectName = document.getElementById('project-name').value || 'untitled';
            const data = {
                name: projectName,
                revenues: projectData.revenues,
                margins: projectData.margins,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem(`project_${projectName}`, JSON.stringify(data));
            showToast('Project saved!');
        }

        // Project Load
        function loadProject() {
            const projectName = document.getElementById('project-name').value;
            const data = localStorage.getItem(`project_${projectName}`);
            
            if (data) {
                const project = JSON.parse(data);
                projectData = project;
                showToast('Project loaded!');
                calculate();
            } else {
                showToast('Project not found', 'error');
            }
        }

        // Template Download (Enhanced Version)
        function downloadTemplate() {
            const wb = XLSX.utils.book_new();
            
            // 1. Revenue Data Sheet
            const ws_data = [
                ['Year', 'Revenue ($M)'],
                [1, 100],
                [2, 120],
                [3, 145],
                [4, 175],
                [5, 210],
                [6, 252],
                [7, 302],
                [8, 363],
                [9, 435],
                [10, 522]
            ];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Revenue Data");
            
            // 2. Usage Guide Sheet
            const guide_data = [
                ['üìä Excel Template Usage Guide'],
                [''],
                ['1. How to Fill'],
                ['   - Enter annual revenue in "Revenue Data" sheet'],
                ['   - Column A: Year (1, 2, 3, ... in order)'],
                ['   - Column B: Revenue (in Million USD)'],
                [''],
                ['2. Upload Method'],
                ['   - Select "Upload Revenue Data" in dashboard'],
                ['   - Choose your Excel file'],
                ['   - Data will be imported automatically'],
                [''],
                ['3. Sample Data'],
                ['   - Base Year Revenue: $100M'],
                ['   - CAGR: ~20% (Compound Annual Growth Rate)'],
                ['   - Period: 10 years'],
                [''],
                ['4. Notes'],
                ['   - Do not modify the header row'],
                ['   - Enter numbers only (in Million USD)'],
                ['   - Maximum 20 years supported'],
                ['   - Empty rows will be ignored'],
                [''],
                ['5. Contact'],
                ['   - GitHub: https://github.com/koing999/HUB'],
                ['   - Email: koing756@naver.com']
            ];
            const ws_guide = XLSX.utils.aoa_to_sheet(guide_data);
            XLSX.utils.book_append_sheet(wb, ws_guide, "Usage Guide");
            
            // 3. CAGR Reference Sheet
            const cagr_data = [
                ['CAGR Reference Table'],
                [''],
                ['Base Revenue', 'CAGR', '10-Year Revenue'],
                [100, '10%', 259],
                [100, '15%', 405],
                [100, '20%', 619],
                [100, '25%', 931],
                [100, '30%', 1379],
                [''],
                ['üí° Tip: Use "CAGR-based Revenue Generation" feature in dashboard'],
                ['to automatically generate revenue projections!']
            ];
            const ws_cagr = XLSX.utils.aoa_to_sheet(cagr_data);
            XLSX.utils.book_append_sheet(wb, ws_cagr, "CAGR Reference");
            
            XLSX.writeFile(wb, "Investment_Analysis_Revenue_Template.xlsx");
            
            showToast('Template downloaded! üìä', 'success');
        }

        // Excel Download
        function downloadExcel() {
            const tbody = document.getElementById('fcf-table-body');
            if (!tbody || tbody.children.length === 0) {
                showToast('Please run analysis first', 'error');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            const fcfData = [
                ['Year', 'Revenue', 'Op. Profit', 'NOPAT', 'D&A', 'CAPEX', 'ŒîNWC', 'FCF', 'Disc. FCF']
            ];
            
            Array.from(tbody.children).forEach(row => {
                const cells = Array.from(row.children).map(cell => cell.textContent.trim().replace(/,/g, ''));
                fcfData.push(cells);
            });
            
            const ws1 = XLSX.utils.aoa_to_sheet(fcfData);
            XLSX.utils.book_append_sheet(wb, ws1, "Cash Flow");
            
            const summaryData = [
                ['Investment Analysis Summary'],
                [''],
                ['Metric', 'Value', 'Unit'],
                ['NPV', document.getElementById('npv-value').textContent.replace(/,/g, ''), '$M'],
                ['IRR', document.getElementById('irr-value').textContent.replace(/,/g, ''), '%'],
                ['Payback Period', document.getElementById('payback-value').textContent, 'Years'],
                ['BEP', document.getElementById('bep-value').textContent, 'Years'],
                ['Investment Decision', document.getElementById('verdict-value').textContent, '']
            ];
            
            const ws2 = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws2, "Summary");
            
            const projectName = document.getElementById('project-name').value || 'investment_analysis';
            XLSX.writeFile(wb, `${projectName}_analysis_results.xlsx`);
            
            showToast('Excel downloaded!');
        }

        // Share
        function shareResults() {
            const url = window.location.href;
            navigator.clipboard.writeText(url);
            showToast('Link copied to clipboard!');
        }

        // Initialize
        window.onload = function() {
            generateRevenue();
            showToast('Dashboard ready!', 'info');
        };
    </script>
</body>
</html>
